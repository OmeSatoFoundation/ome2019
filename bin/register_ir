#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import sys
import subprocess
from subprocess import Popen

IRLOG_PATH = '/tmp/irlog.txt'
CMD = "mode2 -d /dev/lirc1 | tee " + IRLOG_PATH
# CMD = "./unittest.py"
LIRC_CONF_TEMPLATE = """begin remote

	name {remote_name}
	flags RAW_CODES
	eps 30
	aeps 100

	gap 200000
	toggle_bit_mask 0x0

        {signals}

end remote
"""
SIGNALS_TEMPLATE = """
	begin raw_codes
	name {signal_name}
	{signal}
	end raw_codes
"""

def convert_pattern(mode2_string):
    signals = [(line.split()[0], line.split()[1]) for line in mode2_string.strip().split('\n')[1:]]
    idx = 0
    while signals[idx][0] == 'space':
        idx += 1

    signals = signals[idx:]
    if len(signals) % 2 == 0:
        signals = signals[:-1]

    cnt = 0
    result = ""
    for sig in signals:
        s = sig[1]
        cnt += len(str(s)) + 1
        if cnt >= 50:
            result += '\n'
            cnt = 0
        result += s + " "
    return result

def main():
    # get remote name
    remote_name = input('リモコンの名前を入力してください。')
    # while get signal name
    patterns_cnt = 0
    patterns = {}
    try:
        while True:
            signal_name = input('信号の名前を入力してください。終了する場合はCtrl+Dを押してください。')
            if signal_name == "":
                continue
            print('赤外線を照射してください')
            # mode2
            mode2 = Popen(CMD, shell=True, stdout=subprocess.PIPE)
            input('照射が終わったらqを入力した後Enterを押してください')
            buf = ""
            while True:
                line = mode2.stdout.readline().decode('utf-8')
                buf += line
                sys.stdout.write(line)
                if not line:
                    break
                patterns_cnt += 1
            # mode2.terminate()

            # convert_pattern
            patterns[signal_name] = convert_pattern(buf)
    except EOFError:
        pass

    if patterns_cnt > 255:
        print("警告: 信号数が255個を超えています。")

    # generate *.lircd.conf
    signals_str = ""
    for k, v in patterns.items():
        signals_str += SIGNALS_TEMPLATE.format(signal_name = k, signal = v)

    conf_str = LIRC_CONF_TEMPLATE.format(remote_name = remote_name, signals = signals_str)

    # create a file in /etc/lirc
    with open("/etc/lirc/lircd.conf.d/{}.lircd.conf".format(remote_name), "w") as f:
        f.write(conf_str)

    print("信号の登録が完了しました。以下のコマンドでlircdを再起動してください。\nsudo systemctl restart lircd\n以下のコマンドをタイプして赤外線を送信できます\nirsend SEND_ONCE {} 信号名".format(remote_name))

if __name__ == '__main__':
    main()
